#!/bin/sh
#===============================================================================
#
#          FILE:  tails-backup-supersecrets
#
#         USAGE:  If this script already was added on the path (e.g. ~/bin), run:
#                     tails-backup-supersecrets
#
#   DESCRIPTION:  tails-backup-supersecrets IS AN DRAFT. Not tested
#                 Read also:
#                   - https://tails.boum.org/blueprint/backups/
#
#       OPTIONS:  ---
#  REQUIREMENTS:  ---
#          BUGS:  ---
#         NOTES:  ---
#        AUTHOR:  Emerson Rocha <rocha[at]ieee.org>
#       COMPANY:  Etica.AI
#       LICENSE:  Public Domain
#       VERSION:  0.2
#       CREATED:  2020-10-26 22:34 UTC
#      REVISION:  2020-10-26 22:34 UTC v0.2 Creates a /tmp/supersecrets/${TIMESTAMP}.tar
#                                      from .ssh and .gnupg (both ~ and TailsData_unlocked)
#===============================================================================
PROGRAM_START_DATETIME=$(date +%s)
PROGRAM_NAME=$(basename "$0")
set -e

TIMESTAMP=$(date +'%FT%T')

##### Working directory ________________________________________________________
### /tmp/supersecrets ..........................................................
# On tails /tmp is granted to run from RAM
if [ ! -d "/tmp/supersecrets" ];
then
    echo "$PROGRAM_NAME: Creating /tmp/supersecrets..."
    mkdir --mode=0700 /tmp/supersecrets
fi

### /tmp/supersecrets/TIMESTAMP ................................................
# On tails /tmp is granted to run from RAM
echo "$PROGRAM_NAME: Creating /tmp/supersecrets/${TIMESTAMP}"
mkdir --mode=0700 "/tmp/supersecrets/${TIMESTAMP}"

##### Compress and encrypt _____________________________________________________
### /tmp/supersecrets/TIMESTAMP.tar ............................................
# tar -cf
tar -cvhf "/tmp/supersecrets/${TIMESTAMP}.tar" \
  /home/amnesia/.ssh \
  /home/amnesia/.gnupg \
  /live/persistence/TailsData_unlocked/.ssh \
  /live/persistence/TailsData_unlocked/.gnupg

# TODO: check first if folders do exist before trying to backup

##### Open diretory for the user _______________________________________________
### /tmp/supersecrets ..........................................................
# We will open the navigator for user see the end result and continue the
# backup procress
xdg-open /tmp/supersecrets

# @see https://risanb.com/code/backup-restore-gpg-key/
# @see https://gist.github.com/chrisroos/1205934
# @see https://superuser.com/questions/1110877/how-do-you-safely-backup-a-gpg-private-key

echo "$PROGRAM_NAME: TODO: finish tails-backup-supersecrets"

PROGRAM_END_DATETIME=$(date +%s)
PROGRAM_TIME=$((PROGRAM_END_DATETIME-PROGRAM_START_DATETIME))

echo "$PROGRAM_NAME Runtime: $PROGRAM_TIME"
exit 0
